"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(t){var f=["json","text","blob"],h={json:"json",html:"text",txt:"text",md:"text",jpg:"blob",jpeg:"blob",png:"blob",ico:"blob",svg:"blob",mp3:"blob",mp4:"blob",webm:"blob",ogg:"blob"},e=new(function(){function e(){_classCallCheck(this,e),this._mode="interval",this._requirementsMet=!0,this._requirements={fetch:!0,promise:!0,requestAnimationFrame:!0},t.fetch&&t.Promise||(console.warn("FeedFetcher - fetch/Promise are not defined on this browser - If you need to use a polyfill make sure it included before importing or including the FeedFetcher script"),this._requirementsMet=!1,t.fetch||(this._requirements.fetch=!1),t.Promise||(this._requirements.promise=!1),t.requestAnimationFrame||(this._requirements.requestAnimationFrame=!1),console.error("Requirements not met: [fetch: "+this._requirements.fetch+"] [Promise:"+this._requirements.promise+'] [requestAnimationFrame - optional for setMode("raf"): '+this._requirements.requestAnimationFrame+"]")),this._nextIntervalID=1,this._feedObjects={},this._animationFrameID=null,this._timeoutPromise=function(r,o,n){return new Promise(function(e,t){setTimeout(function(){t(n)},o),r.then(e,t)})},this._fetchTimeout=function(e,t,r,o){return o=o||"Request timed out.",t=t||{},r=r||15e3,this._timeoutPromise(fetch(e,t),r,o)},"interval"!=this._mode&&this._step()}return _createClass(e,[{key:"setMode",value:function(e){var t=0;for(var r in this._feedObjects){t+=1;break}0==t?this._mode!=e?"interval"==e?(cancelAnimationFrame(this._animationFrameID),this._mode="interval"):"requestAnimationFrame"!=e&&"raf"!=e||(this._requirements.requestAnimationFrame?(this._mode="raf",this._step()):console.warn("FeedFetcher - Cannot change to requestAnimationFrame as it is not supported on this environment.")):console.warn("FeedFetcher - Mode already set to "+e):console.warn("FeedFetcher - Cannot change mode while feed objects have been created.")}},{key:"_step",value:function(){this._animationFrameID=requestAnimationFrame(this._step.bind(this));var e=Date.now();for(var t in this._feedObjects){var r=this._feedObjects[t],o=e-r._lastStep;r._lastStep=e,r._millisecondsSinceLastRefresh+=o,r._millisecondsSinceLastRefresh>=r._refreshRate&&(r._millisecondsSinceLastRefresh=0,this._doFetch(r))}}},{key:"_doFetch",value:function(r){if(r){r._fetchID+=1;var o=!1,n=null,s=!1,i=null,a="",c="",u=!1;this._fetchTimeout(r._url,{cache:"no-store"},r._timeout).then(function(e){if(a=e.status||"",c=e.statusText||"",!e.ok)throw Error(e.status+" - "+e.statusText);return e}).then(function(e){return"json"==r._mode?(o=!0,n=e.clone(),e.json()):"blob"==r._mode?(s=!0,i=e.clone(),e.blob()):e.text()}).then(function(e){if("json"==r._mode){var t=JSON.stringify(e);r._cachedJson[r._url]==t&&r._onSameData?(u="onSameData",r._onSameData(e)):(u=!0,u="onData",r._onData(e,r._cachedJson[r._url]?JSON.parse(r._cachedJson[r._url]):null),r._cachedJson[r._url]=t)}else"blob"==r._mode?(u="onData",r._onData(e,null)):r._cachedText[r._url]==e&&r._onSameData?(u="onSameData",r._onSameData(e)):(u="onData",r._onData(e,r._cachedText[r._url]||null),r._cachedText[r._url]=e)}).catch(function(t){"Request timed out."==t?r._onError?r._onError({errorType:"FETCH_TIMEOUT",errorText:t,feedObject:r,status:a,statusText:c}):console.warn("FeedFetcher - Request timed out",{errorType:"FETCH_TIMEOUT",errorText:t,feedObject:r,status:a,statusText:c}):u?r._onError?r._onError({errorType:"USER_METHOD_ERROR",errorText:t,userMethod:u,feedObject:r,status:a,statusText:c}):console.warn("FeedFetcher - Caught an error within your code in callback function ["+u+"]",{errorType:"USER_METHOD_ERROR",userMethod:u,errorText:t,feedObject:r,status:a,statusText:c}):o?n.text().then(function(e){r._onError?r._onError({errorType:"JSON_PARSE_FAIL",errorText:t,feedObject:r,textContents:e}):console.warn("FeedFetcher - Text contents of failed json response:",{errorType:"JSON_PARSE_FAIL",errorText:t,feedObject:r,textContents:e})}).catch(function(e){r._onError?r._onError({errorType:"JSON_AND_TEXT_PARSE_FAIL",errorText:e,feedObject:r,rawResponse:n}):console.warn("FeedFetcher - Could not read text contents from failed json response:",{errorType:"JSON_AND_TEXT_PARSE_FAIL",errorText:e,feedObject:r,rawResponse:n})}):s?i.text().then(function(e){r._onError?r._onError({errorType:"BLOB_PARSE_FAIL",errorText:t,feedObject:r,textContents:e}):console.warn("FeedFetcher - Text contents of failed blob response:",{errorType:"BLOB_PARSE_FAIL",errorText:t,feedObject:r,textContents:e})}).catch(function(e){r._onError?r._onError({errorType:"BLOB_AND_TEXT_PARSE_FAIL",errorText:e,feedObject:r,rawResponse:n}):console.warn("FeedFetcher - Could not read text contents from failed blob response:",{errorType:"BLOB_AND_TEXT_PARSE_FAIL",errorText:e,feedObject:r,rawResponse:n})}):r._onError?r._onError({errorType:"FETCH_FAIL",errorText:t,feedObject:r,status:a,statusText:c}):console.warn("FeedFetcher - Response could not be fetched",{errorType:"FETCH_FAIL",errorText:t,feedObject:r,status:a,statusText:c})}),r._once&&this.clearInterval(r._feedID)}else console.error("FeedFetcher - Tried to fetch but not feed argument exists or it is null")}},{key:"fetch",value:function(e){this._setLogic(arguments,"fetch")}},{key:"setTimeout",value:function(e){return this._setLogic(arguments,"setTimeout")}},{key:"setInterval",value:function(e){return this._setLogic(arguments,"setInterval")}},{key:"_setLogic",value:function(e,t){var r=this;if(this._requirementsMet){var o=null,n={},s=0;"object"==_typeof(e[s])?(n=e[s],"number"==typeof e[s+1]&&(o=e[s+1])):"string"==typeof e[s]&&(n.url=e[s],"string"==typeof e[s+=1]&&(n.mode=e[s],s+=1),"function"==typeof e[s]&&(n.onData=e[s],s+=1),"function"==typeof e[s]&&(n.onError=e[s],s+=1),"function"==typeof e[s]&&(n.onSameData=e[s],s+=1),"number"==typeof e[s]&&(o=e[s],s+=1)),"setTimeout"==t?(n.once=!0,n.setTimeout=!0):"fetch"==t&&(n.once=!0);var i=this._nextIntervalID;this._nextIntervalID+=1;var a={};if(a._lastStep=(new Date).getTime(),a._feedID=i,a._timeout=n.timeout,o?a._refreshRate=o:n.refreshRate?a._refreshRate=n.refreshRate:a._refreshRate=1e4,a._once=n.once,a._url=n.url||"http://no-url-specified.com/nothing",n.mode){a._mode=n.mode;var c=!1;for(var u in f)f[u]==a._mode&&(c=!0);if(!c)return void console.error("FeedFetcher - Mode ["+a._mode+"] given to feed fetcher through options is not supported.")}else{var l=a._url.split("."),_=l[l.length-1].toLowerCase();a._mode=h[_]||"text"}return n.setTimeout?a._millisecondsSinceLastRefresh=0:a._millisecondsSinceLastRefresh=a._refreshRate,a._fetchID=0,a._cachedJson={},a._cachedText={},a._onData=n.onData||function(e){console.info("FeedFetcher - Received data but no onData method was passed through constructor",{data:e})},a._onSameData=n.onSameData||null,a._onError=n.onError||null,this._feedObjects[i]=a,"interval"==this._mode&&("fetch"==t?this._doFetch(a):"setTimeout"==t?(a._clearMode="timeout",a._clearID=setTimeout(function(){r._doFetch(a)},a._refreshRate)):(this._doFetch(a),a._clearMode="interval",a._clearID=setInterval(function(){r._doFetch(a)},a._refreshRate))),i}console.error("Requirements not met for setFeedInterval: [fetch: "+this._requirements.fetch+"] [Promise:"+this._requirements.promise+"] [requestAnimationFrame: "+this._requirements.requestAnimationFrame+"]")}},{key:"clearInterval",value:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(e){var t=this._feedObjects[e];t&&("interval"==this._mode&&("interval"==t._clearMode?clearInterval(this._feedObjects[e]._clearID):clearTimeout(this._feedObjects[e]._clearID)),delete this._feedObjects[e])})},{key:"clearTimeout",value:function(e){this.clearInterval(e)}}]),e}());t&&(t.feedFetcher=e),"undefined"!=typeof module&&module.exports&&(module.exports=e)}(window);